cmake_minimum_required(VERSION 3.12)
project(sgl_simulator C CXX)

# Set C standard
set(CMAKE_C_STANDARD 99)
set(CMAKE_C_STANDARD_REQUIRED ON)

# Define output directories
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/output)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/output/lib)
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/output/lib)

# Define paths
set(DEMO_DIR ${CMAKE_CURRENT_SOURCE_DIR}/demo)

# Include SGL library
add_subdirectory(sgl)

# Get SGL include directories
get_property(SGL_INCLUDE_DIRS GLOBAL PROPERTY "SGL_INCLUDE_DIRS")

# Define demo application sources
set(DEMO_SOURCES
    ${DEMO_DIR}/main.c
    ${DEMO_DIR}/sgl_port_sdl2.c
    ${DEMO_DIR}/test.c
    ${DEMO_DIR}/bg.c
)

# Create simulator executable
add_executable(sgl_simulator ${DEMO_SOURCES})

# Add dependencies for SGL export
add_dependencies(sgl_simulator sgl_export)

# Include SDL2 and SGL headers
target_include_directories(sgl_simulator PRIVATE
    ${DEMO_DIR}/sdl/include/SDL2
    ${SGL_INCLUDE_DIRS}
    ${CMAKE_CURRENT_SOURCE_DIR}/sgl/source
)

# Link SDL2 libraries
target_link_directories(sgl_simulator PRIVATE
    ${DEMO_DIR}/sdl/lib
)

target_link_libraries(sgl_simulator PRIVATE
    sgl
    mingw32
    SDL2main
    SDL2
)

# Copy config file and SDL2.dll post-build
add_custom_command(
    TARGET sgl_simulator POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy
        "${DEMO_DIR}/sgl_config.h"
        "${CMAKE_CURRENT_SOURCE_DIR}/sgl/source/sgl_config.h"
    COMMENT "Copying sgl_config.h"
)

add_custom_command(
    TARGET sgl_simulator POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy_if_different
        "${DEMO_DIR}/sdl/bin/SDL2.dll"
        $<TARGET_FILE_DIR:sgl_simulator>
    COMMENT "Copying SDL2.dll to output directory"
)

# Copy config file to build directory
file(COPY ${DEMO_DIR}/lm.cfg DESTINATION ${CMAKE_BINARY_DIR}/)

message(STATUS "SGL Simulator configured successfully")

